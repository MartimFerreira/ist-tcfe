\section{Theoretical Analysis}
\label{sec:analysis}


% MUITO IMPORTANTE: LER OS COMENTÁRIOS


\subsection{DC analysis}
Using the theoretical DC model, the operating point was computed.


\subsubsection{Gain stage}
Replacing resistors $R_{B1}$ and $R_{B2}$, which are in parallel, with an equivalent resistor $R_{B}$, we have
\begin{equation}
R_B = \frac{R_{B1} R_{B2}}{R_{B1}+R_{B2}}
\end{equation}

Looking at the circuit as a voltage divider, we have
\begin{equation}
V_{eq} = \frac{R_{B2}}{R_{B1}+R_{B2}} V_{cc}
\end{equation}

Using the mesh analysis for the mesh on the left side and assuming that the current is going clockwise,
\begin{equation}
V_{eq} + R_B I_{B1} + V_{BEON} + R_{E1} I_{E1} = 0
\end{equation}

Since $I_{E1} = (1 + \beta_{FN}) I_{B1}$, that is equal to 
\begin{equation}
I_{B1} = \frac{V_{eq}-V_{BEON}}{R_B + (1+\beta_{FN}) R_{E1}}
\end{equation}

Taking into account that $I_{C1} = \beta_{FN} I_{B1}$, $V_{O1} = V_{cc} - R_{C1} I_{C1}$ (mesh analysis for the mesh on the right with current going counterclockwise), $V_{E1} = R_{E1} I_{E1}$ (Ohm's Law) and $V_{CE1} = V_{O1} - V_{E1}$, it is possible to determine $R_B$, $V_{eq}$, $I_{B1}$, $I_{C1}$, $I_{E1}$, $V_{O1}$, $V_{E1}$ and $V_{CE1}$ (all the currents and voltages in the circuit).

% apresentar estes valores, assim como os que já são conhecidos (R_{B1}, R_{B2}, V_{cc}, V_{BEON}, \beta_F e resistências)

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|}
    \hline
      \input{resultsDC1_tab.tex}
  \end{tabular}
  \caption{Values obtained}
  \label{tab:resultsDC1}
\end{table}



\subsubsection{Output stage}
We know that $V_{I2}=V_{O1}$.

Circulating in the outer mesh, one has
\begin{equation}
I_{E2} = \frac{V_{cc}-V_{BEON}-V_{I2}}{R_{E2}}
\end{equation}

For the mesh on the right,
\begin{equation}
V_{O2} = V_{cc} -R_{E2} I_{E2}
\end{equation}

Lastly, for the mesh on the left side,
\begin{equation}
V_{O2} = V_{I2} + V_{BEON}
\end{equation}

Also $I_{C2} = \beta_{FP}/(\beta_{FP}+1)\times IE2$.

So it is possible to calculate $I_{E2}$, $I_{C2}$, $V_{O2}$ and $V_{I2}$.

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|}
    \hline
      \input{resultsDC2_tab.tex}
  \end{tabular}
  \caption{Values obtained}
  \label{tab:resultsDC2}
\end{table}

% comparar com o Ngspice -----> FAZER!

%----------------------------------------------------------------



\subsection{AC analysis}
The gain, input and output impedances were computed for each of the stages separately.

\subsubsection{Gain stage}
As shown in theretical classes, they are, respectively, equal to 
\begin{equation}
\begin{cases}
%Gain_1 = R_{C1} \times \frac{R_{E1}-g_{m1} \times r_{\pi 1} \times r_{o1}}{(r_{o1}+R_{C1}+R_{E1})\times(R_B+r_{\pi 1}+R_{E1})+g_{m1} \times R_{E1} \times r_{o1} \times r_{\pi 1} - R_{E1}^2} \\ %& \mbox{$(1)$}\\
%AV1= RC1*(RE1-gm1*rpi1*ro1)/((ro1+RC1+RE1)*(RB+rpi1+RE1)+gm1*RE1*ro1*rpi1 - RE1^2)
%AV1simple = gm1*RC1/(1+gm1*RE1)						       
%AV1simple2 = gm1*RC1/(1+gm1*RE1) * rpi1/ (RS + rpi1)
Gain_1 = \frac{gm1 \times RC1}{1+gm1 \times RE1} \times \frac{r_{\pi1}}{R_S+r_{\pi1}}
Z_{I1} = \frac{(r_{o1}+R_{C1}+R_{E1}) \times (R_B+r_{\pi 1}+R_{E1}) + g_{m1} \times R_{E1} \times r_{o1} \times r_{\pi 1} - R_{E1}^2}{r_{o1} + R_{C1} + R_{E1}} \\ %& \mbox{$(2)$}\\
Z_{O1} = \frac{1}{\frac{1}{Z_X}+\frac{1}{R_{C1}}} \\ %& \mbox{$(3)$}\\
\end{cases}
\end{equation}

With $g_{m1}=\frac{I_{C1}}{V_T}$, $r_{\pi 1}=\frac{\beta_{FN}}{g_{m1}}$, $r_{o1}=\frac{V_A}{I_{C1}}$ and $Z_X = r_{o1} \times \frac{(R_B+r_{\pi 1}) \times \frac{R_{E1}}{R_B+r_{\pi 1}+R_{E1}}}{\frac{1}{\frac{1}{r_{o1}}+\frac{1}{r_{\pi 1}+R_B}+\frac{1}{R_{E1}}+ g_{m1} \times \frac{r_{\pi 1}}{r_{\pi 1}+R_B}}}$.


One should note that the expression for the gain was obtained by simplifying the original one, which was $Gain_1 = R_{C1} \times \frac{R_{E1}-g_{m1} \times r_{\pi 1} \times r_{o1}}{(r_{o1}+R_{C1}+R_{E1})\times(R_B+r_{\pi 1}+R_{E1})+g_{m1} \times R_{E1} \times r_{o1} \times r_{\pi 1} - R_{E1}^2}$. Assuming that the frequencies used are such that the capacitor works as a short-circuit, one can use $R_E=0$. Besides that, since $R_{B1}, R_{B2} \ll r_{\pi1}$ and $r_{o1} \ll R_C$, we have that the equivalent resistance for the parallel of resistors $R_{B1} || R_{B2} || r_{\pi1}$ and $r_{o1} || R_C$ are approximately equal to $r_{\pi1}$ and $R_C$, respectively.



\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|}
    \hline
      \input{resultsAC1_tab.tex}
  \end{tabular}
  \caption{Values obtained}
  \label{tab:resultsAC1}
\end{table}


\subsubsection{Output stage}
As for the output stage, those same quantities are equal to
\begin{equation}
\begin{cases}
Gain_2 = \frac{g_{m2}}{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}} \\ %& \mbox{$(1)$}\\
Z_{I2}= \frac{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}}{g_{\pi 2} \times (g_{\pi 2}+g_{o2}+g_{e2})} \\ %& \mbox{$(2)$}\\
Z_{O2} = \frac{1}{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}} \\ %& \mbox{$(3)$}\\
\end{cases}
\end{equation}

Where $g_{m2} = \frac{I_{C2}}{V_T}$, $g_{o2} = \frac{I_{C2}}{V_A}$, $g_{\pi 2} = \frac{g_{m2}}{\beta_{FP}}$ and $g_{e2} = \frac{1}{R_{E2}}$.

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|}
    \hline
      \input{resultsAC2_tab.tex}
  \end{tabular}
  \caption{Values obtained}
  \label{tab:resultsAC2}
\end{table}

% explain why they can be connected without signal loss -----> EXPLAIN!
In the Common Emitter Transistor (Gain Stage), it was necessary to have some form of "Base Biasing" for the transistor to operate within its “Active Region”. The small Base Bias voltage added to the input signal allowed the transistor to reproduce the full input wave at its output without there being a loss of signal.

The gain stage output impedance and the output stage input impedance are both high, though the latter is an order of magnitude greater than the former, which prevents there being a signal loss and therefore allows both stages to be connected without any problem.
% rewatch lecture?

%----------------------------------------------------------------


\subsection{Total gain, input and output impedances}
The results for the total gain, and input and ouput impedances of the circuit are presented in the table below.

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|}
    \hline
      \input{final_tab.tex}
  \end{tabular}
  \caption{Results obtained for the circuit as a whole}
  \label{tab:resultsAC2}
\end{table}

%----------------------------------------------------------------

\subsection{Frequency response}
Using the incremental circuit and solving the circuit for frequencies ranging from $10 Hz$ to $100 MHz$, the frequency response $\frac{V_o(f)}{V_i(f)}$.

\begin{figure}[H] \centering
\includegraphics[width=0.7\linewidth]{vmag_plot1.eps}
\caption{Frequency response $\frac{V_o(f)}{V_i(f)}$}
\label{fig:freq_response}
\end{figure}


% ainda falta.... bandwidth and cut off frequencies (com base no gráfico? como na simulação)  + voltage gain + cost -----> FAZER!





%\begin{figure}[H] \centering
%\includegraphics[width=0.6\linewidth]{v_out_plot.eps}
%\caption{Output voltage for Envelope Detector (v(mid1), in red) and Voltage Regulator (v(out1), in blue)}
%\label{fig:octave_centered_output}
%\end{figure}
