\section{Theoretical Analysis}
\label{sec:analysis}


% MUITO IMPORTANTE: LER OS COMENTÁRIOS

For this part the circuit is the same as in \textit{ngspice}.
% Há diferenças?

\subsection{DC analysis}
Using the theoretical DC model, the operating point was computed.


\subsubsection{Gain stage}
Replacing resistors $R_{B1}$ and $R_{B2}$, which are in parallel, with an equivalent resistor $R_{B}$, we have
\begin{equation}
R_B = \frac{R_{B1} R_{B2}}{R_{B1}+R_{B2}}
\end{equation}

Looking at the circuit as a voltage divider, we have
\begin{equation}
V_{eq} = \frac{R_{B2}}{R_{B1}+R_{B2}} V_{cc}
\end{equation}

Using the mesh analysis for the mesh on the left side and assuming that the current is going clockwise,
\begin{equation}
V_{eq} + R_B I_{B1} + V_{BEON} + R_{E1} I_{E1} = 0
\end{equation}

Since $I_{E1} = (1 + \beta_F) I_{B1}$, that is equal to 
\begin{equation}
I_{B1} = \frac{V_{eq}-V_{BEON}}{R_B + (1+\beta_F) R_{E1}}
\end{equation}

Taking into account that $I_{C1} = \beta_F I_{B1}$, $V_{O1} = V_{cc} - R_{C1} I_{C1}$ (mesh analysis for the mesh on the right with current going counterclockwise), $V_{E1} = R_{E1} I_{E1}$ (Ohm's Law) and $V_{CE1} = V_{O1} - V_{E1}$, it is possible to determine $R_B$, $V_{eq}$, $I_{B1}$, $I_{C1}$, $I_{E1}$, $V_{O1}$, $V_{E1}$ and $V_{CE1}$ (all the currents and voltages in the circuit).

% apresentar estes valores, assim como os que já são conhecidos (R_{B1}, R_{B2}, V_{cc}, V_{BEON}, \beta_F e resistências)



\subsubsection{Output stage}
Circulating in the outer mesh, one has
\begin{equation}
I_{E2} = \frac{V_{cc}-V_{BEON}-V_{I2}}{R_{E2}}
\end{equation}

For the mesh on the right,
\begin{equation}
V_{O2} = V_{cc} -R_{E2} I_{E2}
\end{equation}

Lastly, for the mesh on the left side,
\begin{equation}
V_{O2} = V_{I2} + V_{BEON}
\end{equation}

So it is possible to calculate $I_{E2}$, $V_{O2}$ and $V_{I2}$.

% comparar com o Ngspice -----> FAZER!

%----------------------------------------------------------------



\subsection{AC analysis}
The gain, input and output impedances were computed for each of the stages separately.

\subsubsection{Gain stage}
As shown in theretical classes, they are, respectively, equal to 
\begin{equation}
\begin{cases}
Gain_{gain \ stage} = R_{C1} \times \frac{R_{E1}-g_{m1} \times r_{\pi 1} \times r_{o1}}{(r_{o1}+R_{C1}+R_{E1})\times(R_B+r_{\pi 1}+R_{E1})+g_{m1} \times R_{E1} \times r_{o1} \times r_{\pi 1} - R_{E1}^2} \\ %& \mbox{$(1)$}\\
Z_{I1} = \frac{(r_{o1}+R_{C1}+R_{E1}) \times (R_B+r_{\pi 1}+R_{E1}) + g_{m1} \times R_{E1} \times r_{o1} \times r_{\pi 1} - R_{E1}^2}{r_{o1} + R_{C1} + R_{E1}} \\ %& \mbox{$(2)$}\\
Z_{O1} = \frac{1}{\frac{1}{Z_X}+\frac{1}{R_{C1}}} \\ %& \mbox{$(3)$}\\
\end{cases}
\end{equation}

With $g_{m1}=\frac{I_{C1}}{V_T}$, $r_{\pi 1}=\frac{\beta_F}{g_{m1}}$, $r_{o1}=\frac{V_A}{I_{C1}}$ and $Z_X = r_{o1} \times \frac{(R_B+r_{\pi 1}) \times \frac{R_{E1}}{(R_B+r_{\pi 1}+R_{E1})}}{\frac{1}{\frac{1}{r_{o1}}+\frac{1}{r_{\pi 1}+R_B}+\frac{1}{R_{E1}}+ g_{m1} \times \frac{r_{\pi 1}}{r_{\pi 1}+R_B})}$.


\subsubsection{Output stage}
As for the output stage, those same quantities are equal to
\begin{equation}
\begin{cases}
Gain_2 = \frac{g_{m2}}{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}} \\ %& \mbox{$(1)$}\\
Z_{I2}= \frac{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}}{g_{\pi 2} \times (g_{\pi 2}+g_{o2}+g_{e2})} \\ %& \mbox{$(2)$}\\
Z_{O2} = \frac{1}{g_{m2}+g_{\pi 2}+g_{o2}+g_{e2}} \\ %& \mbox{$(3)$}\\
\end{cases}
\end{equation}

Where $g_{m2} = \frac{I_{C2}}{V_T}$, $g_{o2} = \frac{I_{C2}}{V_A}$, $g_{\pi 2} = \frac{g_{m2}}{\beta_F}$ and $g_{e2} = \frac{1}{R_{E2}}$.

% explain why they can be connected without signal loss -----> EXPLAIN!
In the Common Emitter Transistor (Gain Stage), it was necessary to have some form of "Base Biasing" for the transistor to operate within its “Active Region”. The small Base Bias voltage added to the input signal allowed the transistor to reproduce the full input wave at its output without there being a loss of signal.

The gain stage output impedance and the output stage input impedance are both high, though the latter is an order of magnitude greater than the former, which prevents there being a signal loss and therefore allows both stages to be connected without any problem.
% rewatch lecture?

%----------------------------------------------------------------



\subsection{Frequency response}
%----------------------------------------------------------------




\begin{figure}[H] \centering
\includegraphics[width=0.6\linewidth]{v_centered_output_plot.eps}
\caption{Difference (in mV) between the Output Voltage and the desired 12V}
\label{fig:phase_sim}
\end{figure}

\begin{figure}[H] \centering
\includegraphics[width=0.6\linewidth]{v_out_plot.eps}
\caption{Output voltage for Envelope Detector (v(mid1), in red) and Voltage Regulator (v(out1), in blue)}
\label{fig:octave_centered_output}
\end{figure}
