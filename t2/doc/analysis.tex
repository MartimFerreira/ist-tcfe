\section{Theoretical Analysis}
\label{sec:analysis}


% MUITO IMPORTANTE: LER OS COMENTÁRIOS

\subsection{Circuit when $t<0$} % ---> alínea 1
For $t<0$, $v_S(t) = V_S$, according to the given equations, and $I_c=0$, since it is considered that the capacitor had been charging for a long time and eventually reached steady-state and in that moment the current is null. Taking this into account it was possible to determine the voltages in all of the nodes using the nodal method. The equations obtained were the following ones:

% * pus V_0 em vez de V_4
% * retirei I_c das equações por ser nulo

\begin{equation}
  \begin{cases}
  V_0 = 0 & \mbox{$node 0$}\\
  V_1-V_0 = V_S & \mbox{node 1} \\
  \frac{V_2-V_1}{R_1}+\frac{V_2-V_3}{R_2}+\frac{V_2-V_5}{R_3} = 0 & \mbox{node 2} \\
  (V_5-V_2)K_b + \frac{V_3-V_2}{R_2} = 0 & \mbox{node 3} \\
  (V_2-V_5)K_b + \frac{V_6-V_5}{R_5} = 0 & \mbox{node 6} \\
  \frac{V_0-V_7}{R_6} - \frac{V_7-V_8}{R_7} = 0 & \mbox{node 7} \\
  (V_5-V_8) = K_d \frac{V_0-V_7}{R_6} & \mbox{node 8} \\
  \frac{V_2-V_5}{R_3} - \frac{V_5-V_0}{R_4} + \frac{V_6-V_5}{R_5} + \frac{V_7-V_8}{R_7}  = 0 & \mbox{supernode 5-8} \\ 
  \end{cases}
\end{equation}
% As soluções são [V0,V1,V2,V3,V4,V5,V6,V7,V8]

The first two equations were obtained by inspection, whereas the rest were through KCL. Note that $V_b=V_2-V_5$.
Solving this system of equations the value of the voltage in each node was determined and, subsequently, the current in every branch.

% *** tabela com os resultados: potencial em todos os nós e corrente em cada ramo





\subsection{Circuit when $t=0$} % ---> alínea 2
Making $V_S=0$, 0 and 1 become the same node, the ground node, which means that $V_0=V_1=0$, and replacing the capacitor with a voltage source $V_X=V_6-V_8$, $V_6$ and $V_8$ being, respectively, the voltage in nodes 6 and 8 obtained for $t<0$.
Using once again the nodal analysis the value of $I_X$, the current that goes through $V_X$, was found out. Because the value of $V_X$ was already known, the equivalent resistor $R_{eq} = \frac{V_X}{I_X}$ was computed, as well as the time constant $\tau = R_{eq}C$, $C$ being the capacitance.
The reason for adopting this procedure was that the capacitor's terminals are connected to nodes 6 and 8 and, even though the values of $V_6$ and $V_8$ may change when $t=0$, the electric potential difference, $V_6-V_8$, has to remain the same. There has to be continuity regarding what happens when $t<0$ and in instant $t=0$. Besides that, as learnt in the theory classes, to compute the equivalent resistor as seen by the capacitor (and later the time constant), one has to consider that all independent sources are switched off, which is why it was assumed that $V_S=0$. The remaining sources are all dependent so the traditional analysis using the fact that the resistors were either in series or in parallel to simplify the circuit could not be applied here.
Using once again the nodal analysis method, one reaches the following equations:

\begin{equation}
  \begin{cases}
  V_0=0 & \mbox{node 0} \\
  V_1=0 & \mbox{node 1} \\
  \frac{V_2-V_1}{R_1}+\frac{V_2-V_3}{R_2}+\frac{V_2-V_5}{R_3} = 0 & \mbox{node 2} \\
  (V_5-V_2)K_b + \frac{V_3-V_2}{R_2} = 0 & \mbox{node 3} \\
  V_6-V_8 = V_X & \mbox{node 6} \\
  \frac{V_0-V_7}{R_6} - \frac{V_7-V_8}{R_7} = 0 & \mbox{node 7} \\
  (V_5-V_8) = K_d \frac{V_0-V_7}{R_6} & \mbox{node 8} \\
  \frac{V_2-V_5}{R_3} + \frac{V_0-V_5}{R_4} + \frac{V_6-V_5}{R_5} + \frac{V_7-V_8}{R_7} = 0 & \mbox{supernode 5-8} \\ 
  \end{cases}
\end{equation}
% As soluções são [V0,V1,V2,V3,V5,V6,V7,V8]

After finding the values of the voltage in every node for instant $t=0$ one can solve equation $(V_2-V_5)K_b + \frac{V_6-V_5}{R_5} + I_X = 0$ for node 6 and, therefore, know the value of $I_X$.

% *** tabela com os resultados




\subsection{Circuit when $t>0$}

\subsubsection{Natural solution}  % ---> alínea 3
As learnt in lectures, the natural solution is of the form $v_{6_{n}}(t) = A e^{-\frac{t}{R_{eq}C}}$, where $A$ is an integration constant.
Using the initial condition $v_{6_{n}}(t=0) = V_X$, which is the capacitor voltage for instant $t=0$, one can conclude that $A= V_X$. Thus $v_{6_{n}}(t) = V_X e^{-\frac{t}{R_{eq}C}}$.

% *** show natural solution
% *** plot v_6_n(t) for [0, 20] ms, idetify axes, display signals and units


\begin{figure}[H] \centering
\includegraphics[width=0.8\linewidth]{v6natural_plot.eps}
\caption{Natural response voltage in node 6.}
\label{fig:natural}
\end{figure}


\subsubsection{Forced solution}  % ---> alínea 4
To determine the forced solution, $v_{6_{f}}(t)$, in the same interval with $f=1kHz$ it was assumed that $V_S=1$, $C$ was replaced with its impedance$Z_c$ and then through the nodal analysis the phasor voltage in each node was calculated. Below is the system of equations that was used.


\begin{equation}
  \begin{cases}
  \tilde{V}_0 = 0 & \mbox{node 0} \\
   \tilde{V}_1 = \tilde{V}_S & \mbox{node 1} \\
  \frac{\tilde{V}_2-\tilde{V}_1}{R_1}+\frac{\tilde{V}_2-\tilde{V}_3}{R_2}+\frac{\tilde{V}_2-\tilde{V}_5}{R_3} = 0 & \mbox{node 2} \\
  (\tilde{V}_5-\tilde{V}_2)K_b + \frac{\tilde{V}_3-\tilde{V}_2}{R_2} = 0 & \mbox{node 3} \\
  (-\tilde{V}_5+\tilde{V}_2)K_b + \frac{\tilde{V}_6-\tilde{V}_5}{R_5} + \frac{\tilde{V}_6-\tilde{V}_8}{Z_c} = 0 & \mbox{node 6} \\
  \frac{\tilde{V}_0-\tilde{V}_7}{R_6} - \frac{\tilde{V}_7-\tilde{V}_8}{R_7} = 0 & \mbox{node 7} \\
  (\tilde{V}_5-\tilde{V}_8) = K_d \frac{\tilde{V}_0-\tilde{V}_7}{R_6} & \mbox{node 8} \\
  \frac{\tilde{V}_2-\tilde{V}_5}{R_3} + \frac{\tilde{V}_0-\tilde{V}_5}{R_4} + \frac{\tilde{V}_6-\tilde{V}_5}{R_5} + \frac{\tilde{V}_7-\tilde{V}_8}{R_7} - \frac{\tilde{V}_6-\tilde{V}_8}{Z_c} = 0 & \mbox{supernode 5-8} \\ 
  \end{cases}
\end{equation}
% As soluções são [\tilde{V}0,\tilde{V}1,\tilde{V}2,\tilde{V}3,\tilde{V}5,\tilde{V}6,\tilde{V}7,\tilde{V}8]

% dizer explicitamente quais são as incógnitas para cada sistema de equações?
% explicar melhor como é que se chegou a cada equação?



% *** show forced solution
% *** tabela com a amplitude complexa nos nós




\subsubsection{Final solution}  % ---> alínea 5
To determine the final total solution, $v_6(t)$, one had to convert the phasors to real time functions, for $f=1kHz$, and superimpose the natural and the forced solutions.
In order to do that the voltage phasors had to be multiplied by $e^{i \omega t}$. Because the stimulus in the circuit, $V_S$, had the form of a sine, the imaginary part of the result was used to determine the forced solution as a real time from the respective phasor, as intended.
Then, summing both the natural and the forced solutions, the final total solution was obtained, $v_6(t) = v_{6_n} (t) + v_{6_f} (t)$.
In the next figure, there are the plots of $v_s(t)$ and $v_6(t)$ in the interval $[-5, 20] \ ms$.

% usar i ou j?
% stimulus será a palavra mais correcta?

\begin{figure}[H] \centering
\includegraphics[width=0.8\linewidth]{vfinal_plot.eps}
\caption{Voltage in node 6 and stimulus Vs.}
\label{fig:final}
\end{figure}





\subsubsection{Frequency response}  % ---> alínea 6
In the previous point $f=1kHz$. However, now the objective is to understand what happens to the phasors for other frequencies. To do that the procedure used for the last point was used for 35 different values of frequency and then the plots of the variation in both magnitude and phase were made for $v_s(f)$, $v_6(f)$ and $v_c(f) = v_6(f)-v_8(f)$, with the frequency ranging between $0.1 \ Hz$ and $1 \ MHz$, using a logarithmic scale.

\begin{figure}[H] \centering
\includegraphics[width=0.8\linewidth]{vmag_plot.eps}
\caption{Variation in magnitude of Vs, voltage in node 6 and voltage between the capacitor terminals with frequency.}
\label{fig:magnitude}
\end{figure}


\begin{figure}[H] \centering
\includegraphics[width=0.8\linewidth]{vphase_plot.eps}
\caption{Variation in phase of Vs, voltage in node 6 and voltage between the capacitor terminals with frequency.}
\label{fig:phase}
\end{figure}

% ------------------> explicar diferenças!!!


% ver print screens da aula gravada que estão nas cenas teóricas 04/02/2021 10:16pm


